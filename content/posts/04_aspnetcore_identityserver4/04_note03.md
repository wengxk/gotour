---
title: "项目实践：IdentityServer4集成ASP.NET Core Identity及SSO的应用"
date: 2019-12-20
type:
- post
- posts
categories:
- ASP.NET CORE and IdentityServer4
---


项目地址，见 [tag:basic_sso_demo](https://github.com/wengxk/aspnetcore_identityserver4/tree/basic_sso_demo)

## 步骤

### 一

创建空解决方案

新建asp.net core mvc 项目，认证类型为个人用户本地存储

修改settings.json

程序包控制管理台：update-database

配置asp.net core identity options

运行项目，注册一个用户，并验证登录正常

### 二

官方的模板项目很多，我们以其中一个进行改造，地址[quickstart](https://github.com/IdentityServer/IdentityServer4/tree/master/samples/Quickstarts/2_InteractiveAspNetCore)，下载后我们检查这个项目是可以直接成功运行的

将两个模板项目都升级为netcoreapp3.1的框架

先修改IdentityServer项目

因为需要和asp.net core identity集成，所以我们先拷贝AccountServer的appsettings.json至IdentityServer项目中

将AccountServer的一些依赖也引用到IdentityServer项目中

```XML
<PackageReference Include="Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore" Version="3.1.0" />
<PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="3.1.0" />
<PackageReference Include="Microsoft.AspNetCore.Identity.UI" Version="3.1.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="3.1.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="3.1.0" />
```

将AccountServer的Data文件夹及其下的文件拷贝至IdentityServer项目中，并修改命名空间

修改IdentityServer项目的startup类，将asp.net core identity的一些必要服务注册至项目中

```C#
services.AddDbContext<ApplicationDbContext>(options =>
        options.UseSqlServer(
            Configuration.GetConnectionString("DefaultConnection")));
    services.AddDefaultIdentity<IdentityUser>(
            options => options.SignIn.RequireConfirmedAccount = false
        ).AddEntityFrameworkStores<ApplicationDbContext>()
        .AddDefaultTokenProviders();
```

---

**Add References**

`dotnet add package IdentityServer4.EntityFramework`

`dotnet add package Microsoft.EntityFrameworkCore.SqlServer` 之前添加过，此处可以忽略

**Configuring the Stores**

```C#
var migrationsAssembly = typeof(Startup).GetTypeInfo().Assembly.GetName().Name;
// configure identity server with in-memory stores, keys, clients and scopes
var builder = services.AddIdentityServer()
      // this adds the config data from DB (clients, resources)
      .AddConfigurationStore(options =>
      {
          options.ConfigureDbContext = b =>
              b.UseSqlServer(Configuration.GetConnectionString("DefaultConnection"),
                  sql => sql.MigrationsAssembly(migrationsAssembly));
      })
      // this adds the operational data from DB (codes, tokens, consents)
      .AddOperationalStore(options =>
      {
          options.ConfigureDbContext = b =>
              b.UseSqlServer(Configuration.GetConnectionString("DefaultConnection"),
                  sql => sql.MigrationsAssembly(migrationsAssembly));

          // this enables automatic token cleanup. this is optional.
          options.EnableTokenCleanup = true;
          options.TokenCleanupInterval = 3600; // interval in seconds (default is 3600)
      });
```

**Adding Migrations**

先检查startup类里有没有注入配置，如果没有则无法进行add migration操作

```C#
public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
        }

public IConfiguration Configuration { get; }
```

`dotnet tool install --global dotnet-ef`

`dotnet add package Microsoft.EntityFrameworkCore.Design`

`dotnet ef migrations add InitialIdentityServerPersistedGrantDbMigration -c PersistedGrantDbContext -o Data/Migrations/IdentityServer/PersistedGrantDb`

`dotnet ef migrations add InitialIdentityServerConfigurationDbMigration -c ConfigurationDbContext -o Data/Migrations/IdentityServer/ConfigurationDb`

**Initializing the Database**

```C#
private void InitializeDatabase(IApplicationBuilder app)
{
    using (var serviceScope = app.ApplicationServices.GetService<IServiceScopeFactory>().CreateScope())
    {
        serviceScope.ServiceProvider.GetRequiredService<PersistedGrantDbContext>().Database.Migrate();

        var context = serviceScope.ServiceProvider.GetRequiredService<ConfigurationDbContext>();
        context.Database.Migrate();
        if (!context.Clients.Any())
        {
            foreach (var client in Config.Clients)
            {
                context.Clients.Add(client.ToEntity());
            }
            context.SaveChanges();
        }

        if (!context.IdentityResources.Any())
        {
            foreach (var resource in Config.Ids)
            {
                context.IdentityResources.Add(resource.ToEntity());
            }
            context.SaveChanges();
        }

        if (!context.ApiResources.Any())
        {
            foreach (var resource in Config.Apis)
            {
                context.ApiResources.Add(resource.ToEntity());
            }
            context.SaveChanges();
        }
    }
}
```

将 `InitializeDatabase` 添加到方法 `Configure` 中

### 三

修改MvcClient项目

先升级下oidc的版本

注册服务

```C#
services.AddAuthentication(options =>
        {
            options.DefaultScheme = "Cookies";
            options.DefaultChallengeScheme = "oidc";
        })
        .AddCookie("Cookies")
        .AddOpenIdConnect("oidc", options =>
        {
            options.Authority = "http://localhost:5000";
            options.RequireHttpsMetadata = false;

            options.ClientId = "mvc";
            options.ClientSecret = "secret";
            options.ResponseType = "code";

            //目前发现一个问题：
            //SaveTokens如果设置为false，在identityserver退出后无法返回mvc客户端，经检查postlogoutredirecturi为null
            options.SaveTokens = true;
        });
```

### 四

配置完成

先后运行IdentityServer项目和MvcClient项目

## 参阅

- [Using EntityFramework Core for configuration and operational data](https://identityserver4.readthedocs.io/en/latest/quickstarts/5_entityframework.html)
- [Entity Framework Support](https://identityserver4.readthedocs.io/en/latest/reference/ef.html)
